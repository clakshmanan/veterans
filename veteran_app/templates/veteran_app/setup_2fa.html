{% extends 'veteran_app/base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Two-Factor Authentication</h4>
                </div>
                <div class="card-body">
                    {% if two_factor.is_enabled %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>2FA is currently <strong>enabled</strong> for your account.
                        </div>
                        
                        <div class="mb-4">
                            <h5>Security Status</h5>
                            <p>Your account is protected with two-factor authentication.</p>
                            <ul>
                                <li>Enabled on: {{ two_factor.enabled_at|date:"F d, Y H:i" }}</li>
                                {% if two_factor.last_used %}
                                <li>Last used: {{ two_factor.last_used|date:"F d, Y H:i" }}</li>
                                {% endif %}
                                <li>Backup codes remaining: {{ two_factor.backup_codes|length }}</li>
                            </ul>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <a href="{% url 'view_backup_codes' %}" class="btn btn-info">
                                <i class="fas fa-key me-2"></i>View Backup Codes
                            </a>
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="disable">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to disable 2FA?')">
                                    <i class="fas fa-times-circle me-2"></i>Disable 2FA
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>2FA is currently <strong>disabled</strong>. Enable it to secure your account.
                        </div>
                        
                        {% if not two_factor.secret_key %}
                            <div class="mb-4">
                                <h5>Step 1: Generate Secret Key</h5>
                                <p>Click the button below to generate a secret key for your authenticator app.</p>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="generate">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-key me-2"></i>Generate Secret Key
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            <div class="mb-4">
                                <h5>Step 2: Scan QR Code</h5>
                                <p>Scan this QR code with your authenticator app (Google Authenticator, Microsoft Authenticator, or Authy):</p>
                                <div class="text-center my-4">
                                    <img src="{{ qr_code }}" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                                </div>
                                <div class="alert alert-info">
                                    <strong>Manual Entry:</strong> If you can't scan the QR code, enter this key manually:<br>
                                    <code class="fs-5">{{ two_factor.secret_key }}</code>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5>Step 3: Verify Code</h5>
                                <p>Enter the 6-digit code from your authenticator app to complete setup:</p>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="verify">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="text" name="code" class="form-control form-control-lg text-center" 
                                                   placeholder="000000" maxlength="6" pattern="[0-9]{6}" required autofocus>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="submit" class="btn btn-success btn-lg w-100">
                                                <i class="fas fa-check me-2"></i>Verify & Enable
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                        
                        <div class="alert alert-light">
                            <h6><i class="fas fa-info-circle me-2"></i>What is Two-Factor Authentication?</h6>
                            <p class="mb-0">2FA adds an extra layer of security to your account. Even if someone knows your password, they won't be able to access your account without the code from your authenticator app.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="text-center mt-3">
                <a href="{% url 'user_settings' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Settings
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
